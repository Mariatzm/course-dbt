{{
  config(
    materialized='table'
  )
}}

WITH stg_events AS (
  SELECT
    *
  FROM {{ ref('stg_postgres__events') }}
)

SELECT
  SESSION_ID
  , USER_ID
  , SUM(CASE WHEN EVENT_TYPE = 'page_view' THEN 1 ELSE 0 END) AS PAGE_VIEWS
  , SUM(CASE WHEN EVENT_TYPE = 'add_to_cart' THEN 1 ELSE 0 END) AS ADD_TO_CARTS
  , SUM(CASE WHEN EVENT_TYPE = 'checkout' THEN 1 ELSE 0 END) AS CHECKOUTS
  , SUM(CASE WHEN EVENT_TYPE = 'package_shipped' THEN 1 ELSE 0 END) AS PACKAGE_SHIPPEDS
  , MAX(CASE WHEN EVENT_TYPE = 'checkout' THEN CREATED_AT ELSE NULL END) AS MAX_CHECKOUT_TIME
  , MAX(CASE WHEN EVENT_TYPE = 'package_shipped' THEN CREATED_AT ELSE NULL END) AS MAX_SHIPPED_TIME
  , MIN(CREATED_AT) AS FIRST_SESSION_EVENT_TIME
  , MAX(CREATED_AT) AS LAST_SESSION_EVENT_TIME
  , DATEDIFF(MINUTES, FIRST_SESSION_EVENT_TIME, LAST_SESSION_EVENT_TIME) AS SESSION_DURATION_MINUTES
FROM stg_events
GROUP BY 1,2